<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	</head>
	<body>
		<h1 id="raspberry-pi-pps-client">Raspberry Pi PPS Client</h1>
		<p>A fast, high accuracy Pulse-Per-Second system clock synchronizer for Raspberry Pi 2.</p><center><img src="./figures/RPi_with_GPS.jpg" alt="Raspberry Pi with GPS" style="width: 400px;"/></center>

		<p>This daemon synchronizes the Raspberry Pi 2 system clock to a Pulse-Per-Second (PPS) source such as the PPS available from a GPS module. The pps-client daemon provides a synchronization precision of 1 micosecond and a timekeeping accuracy of 5 microseconds by design. </p><!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

		<ul>
			<li>
				<a href="#hardware-requirements">Hardware Requirements</a>
			</li>
			<li>
				<a href="#software-requirements">Software Requirements</a>
				<ul>
					<li>
						<a href="#the-raspian-os">The Raspian OS</a>
					</li>
					<li>
						<a href="#the-ntp-daemon">The NTP daemon</a>
					</li>
					<li>
						<a href="#the-chkconfig-system-services-manager">The chkconfig system services manager</a>
					</li>
				</ul>
			</li>
			<li>
				<a href="#installing">Installing</a>
			</li>
			<li>
				<a href="#uninstalling">Uninstalling</a>
			</li>
			<li>
				<a href="#reinstalling">Reinstalling</a>
			</li>
			<li>
				<a href="#building-from-source">Building from Source</a>
				<ul>
					<li>
						<a href="#building-on-a-linux-workstation">Building on a Linux Workstation</a>
					</li>
					<li>
						<a href="#building-on-the-rpi">Building on the RPi</a>
					</li>
				</ul>
			</li>
			<li>
				<a href="#running-pps-client">Running pps-client</a>
			</li>
			<li>
				<a href="#performance-summary">Performance Summary</a>
			</li>
		</ul><!-- END doctoc generated TOC please keep comment here to allow auto update -->

		<h1 id="hardware-requirements">Hardware Requirements</h1>
		<hr/>
		<ol>
			<li>
				<p>A Raspberry Pi 2 Model B or later.</p>
			</li>
			<li>
				<p>A GPS module that provides a PPS output. Development was done with the 
					<a href="http://www.adafruit.com/product/746">Adafruit Ultimate GPS module</a>. Others providing compatible logic levels will also work.
				</p>
			</li>
			<li>
				<p>A wired connection from a PPS source with 3.3 Volt logic outputs to GPIO 4 (pin 7) on the RPi header.</p>
			</li>
			<li>
				<p>A wired connection from GPIO_17 (pin 11) to GPIO_22 (pin 15) to support self calibration (Note the yellow jumper in the photo above).</p>
			</li>
		</ol>
		<h1 id="software-requirements">Software Requirements</h1>
		<hr/>
		<h2 id="the-raspian-os">The Raspian OS</h2>
		<p>Version 3.18.9-rt5 and later versions of Linux kernel 4.1.y are supported. Initial development was done with the 
			<a href="http://docs.emlid.com/Downloads/Real-time-Linux-RPi2/">EMLID Navio kernel</a> because it had real-time patches that were necessay for Linux 3.18.x. The stock 4.1.y kernel now provides equal or better timekeeping performance. 
		</p>
		<h2 id="the-ntp-daemon">The NTP daemon</h2>
		<p>NTP is provided out the box on Raspian. NTP sets the whole seconds of the initial date and time and SNTP maintains the date and time through DST and leap second changes.</p>
		<h2 id="the-chkconfig-system-services-manager">The chkconfig system services manager</h2>
		<p>
			<code>$ sudo apt-get install chkconfig</code>
		</p>
		<p>This is necessary if you want to install pps-client as a system service.</p>
		<h1 id="installing">Installing</h1>
		<hr/>
		<p>The pps-client has several versions of the installer. Copy the appropriate one to the RPi and run it from a terminal:</p>
		<pre><code>$ sudo ./pps-client-4.1.20-v7+
</code></pre>
		<p>The pps-client version must match the version of the Linux kernel on the RPi. The kernel version can be determined by running "
			<code>uname -r</code>" on an RPi terminal. Version matching is necessary because pps-client contains a kernel driver and all kernel drivers are compiled against a specific version of the Linux kernel and can only run on that kernel version.
		</p>
		<p>A few different Linux kernels are currently supported and more will be. This is not the best solution because it means that pps-client has to be re-installed every time Raspian updates the kernel version. The hope is that if there is enough interest in this project, the driver will be accepted into mainline in the upstream kernel.</p>
		<h1 id="uninstalling">Uninstalling</h1>
		<hr/>
		<p>Uninstall pps-client on the RPi with:</p>
		<pre><code>$ sudo pps-client-remove
</code></pre>
		<p>Uninstalling isn't necessary if you are installing over an older version of pps-client.</p>
		<h1 id="reinstalling">Reinstalling</h1>
		<hr/>
		<p>If you want to keep your current pps-client configuration file rename it before you perform a subsequent install of pps-client. Otherwise it will be overwritten with the default. For example, you could preserve it by doing something like,</p>
		<p>$ sudo mv /ect/pps-client.conf /etc/pps-client.conf.orig</p>
		<p>and then, after installing pps-client,</p>
		<p>$ sudo mv /etc/pps-client.conf.orig  /ect/pps-client.conf</p>
		<h1 id="building-from-source">Building from Source</h1>
		<hr/>
		<p>Because pps-client contains a Linux kernel driver, building pps-client requires more than just compiling it. A compiled Linux kernel with the same version as the version present on the RPi must also be available during the compilation of pps-client which can be built on either a Linux workstation (preferred) or directly on the RPi (slower). In either case you will first need to download and compile the Linux kernel that corresponds to the kernel version on your RPi. </p>
		<p>The steps below don't do a complete kernel installation. Only enough is done to get the object files that are necessary for compiling a kernel driver. If you are unable to match your kernel version to the source found 
			<a href="https://github.com/raspberrypi/linux">here</a> instructions for doing a complete kernel install can be found 
			<a href="https://www.raspberrypi.org/documentation/linux/kernel/building.md">here</a>. Otherwise follow the steps below.
		</p>
		<p>If you need git:</p>
		<pre><code>$ sudo apt-get install git
</code></pre>
		<h2 id="building-on-a-linux-workstation">Building on a Linux Workstation</h2>
		<p>You might want to create a folder to hold the kernel and tools. For example,</p>
		<pre><code>$ mkdir ~/rpi
$ cd ~/rpi
</code></pre>
		<p>On a workstation you will need the cross-compiler:</p>
		<pre><code>$ git clone https://github.com/raspberrypi/tools
</code></pre>
		<p>That should create a "tools" folder in "rpi".</p>
		<p>Download the current version of the kernel sources:</p>
		<pre><code>$ git clone --depth=1 https://github.com/raspberrypi/linux
</code></pre>
		<p>This environment variable will be needed both to configure the kernel and to build pps-client:</p>
		<pre><code>$ export CROSS_COMPILE=~/rpi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf-
</code></pre>
		<p>The 
			<code>export</code> command above is temporary. It will survive only until you close the terminal window. To make it persistent you can optionally add the 
			<code>export</code> command to the 
			<code>.bashrc</code> file in your home directory.
		</p>
		<p>Now configure the kernel:</p>
		<pre><code>$ cd linux
$ KERNEL=kernel7
$ make ARCH=arm CROSS_COMPILE=$CROSS_COMPILE bcm2709_defconfig
</code></pre>
		<p>and compile it:</p>
		<pre><code>$ make -j6 ARCH=arm CROSS_COMPILE=$CROSS_COMPILE zImage
</code></pre>
		<p>That will provide the necessary kernel object files to build the driver. If you have not already downloaded the pps-client project, do it now:</p>
		<pre><code>$ cd ~/rpi
$ git clone --depth=1 https://github.com/rascol/PPS-Client
$ cd PPS-Client
</code></pre>
		<p>Now (assuming that the kernel source version is 4.1.20) make the pps-client project. The 
			<code>KERNELDIR</code> argument must point to the folder containing the compiled Linux kernel. If not, change it to point to the correct location of the "linux" folder.
		</p>
		<pre><code>$ make CROSS_COMPILE=$CROSS_COMPILE KERNELDIR=~/rpi/linux KERNELVERS=4.1.20-v7+
</code></pre>
		<p>That will build the installer, 
			<code>pps-client-4.1.20-v7+</code>. Copy this to the RPi. Run it on the RPi as root:
		</p>
		<pre><code>$ sudo ./pps-client-4.1.20-v7+
</code></pre>
		<p>That completes the pps-client installation.</p>
		<h2 id="building-on-the-rpi">Building on the RPi</h2>
		<p>You might want to create a folder to hold the kernel and pps-client project. For example,</p>
		<pre><code>$ mkdir ~/rpi
$ cd ~/rpi
</code></pre>
		<p>Download the current version of the kernel sources:</p>
		<pre><code>$ git clone --depth=1 https://github.com/raspberrypi/linux
</code></pre>
		<p>Get missing dependencies:</p>
		<pre><code>$ sudo apt-get install bc
</code></pre>
		<p>Configure the kernel:</p>
		<pre><code>$ cd linux
$ KERNEL=kernel7
$ make bcm2709_defconfig
</code></pre>
		<p>Compile the kernel (takes about half an hour):</p>
		<pre><code>$ make -j4 zImage
</code></pre>
		<p>That will provide the necessary kernel object files to build the pps-client driver. If you have not already downloaded the pps-client project, do it now:</p>
		<pre><code>$ cd ..
$ git clone --depth=1 https://github.com/rascol/PPS-Client
$ cd PPS-Client
</code></pre>
		<p>Now (assuming that the kernel source version is 4.1.20) make the pps-client project. The 
			<code>KERNELDIR</code> argument must point to the folder containing the compiled Linux kernel. If not, change it to point to the correct location of the "linux" folder.
		</p>
		<pre><code>$ make KERNELDIR=~/rpi/linux KERNELVERS=4.1.20-v7+
</code></pre>
		<p>That will build the installer, 
			<code>pps-client-4.1.20-v7+</code>. Run it on the RPi as root:
		</p>
		<pre><code>$ sudo ./pps-client-4.1.20-v7+
</code></pre>
		<p>That completes the pps-client installation.</p>
		<h1 id="running-pps-client">Running pps-client</h1>
		<hr/>
		<p>The pps-client requires that a PPS hardware signal is available from a GPS module. Once the GPS is connected and the PPS output is present on GPIO 4 you can do a quick try-out with,</p>
		<pre><code>$ sudo pps-client
</code></pre>
		<p>That installs pps-client as a daemon. To watch the controller acquire you can subsequently enter</p>
		<pre><code>$ pps-client -v
</code></pre>
		<p>That runs a secondary copy of pps-client that just displays a status printout that the pps-client daemon continuously generates. When pps-client starts up you can expect to see something like the following in the status printout:</p><center><img src="./figures/StatusPrintoutOnStart.png" alt="Status Printout on Startup" style="width: 634px;"/></center>

		<p>The 
			<code>jitter</code> value is showing the fractional second offset of the PPS signal according to the system clock. That value will decrease second by second as the controller locks to the PPS signal. After about 10 minutes the status printout will look like this:
		</p><center><img src="./figures/StatusPrintoutAt10Min.png" alt="Status Printout after 10 Min" style="width: 634px;"/></center>

		<p>The 
			<code>jitter</code> is displaying small numbers. The time of the rising edge of the PPS signal is shown in the second column. The 
			<code>clamp</code> value on the far right indicates that the maximum time correction applied to the system clock is being limited to one microsecond. The sysem clock is synchronized to the PPS signal to a precision of one microsecond.
		</p>
		<p>It can take as long as 20 minutes for pps-client to fully acquire the first time it runs. This happens if the 
			<code>jitter</code> shown in the status printout is on the order of 100,000 microseconds or more. It's quite common for the NTP fractional second to be off by that amount. In this case pps-client may restart several times as it slowly reduces the 
			<code>jitter</code> offset. That happens because system functions that pps-client calls internally prevent time changes of more than about 500 microseconds in each second.
		</p>
		<p>To stop the display type ctrl-c.</p>
		<p>The daemon will continue to run until you reboot the system or until you stop the daemon with</p>
		<pre><code>$ sudo pps-client-stop
</code></pre>
		<p>To have the pps-client daemon be installed as a system service and loaded on system boot, from the RPi command line enter:</p>
		<pre><code>$ sudo chkconfig --add pps-client
</code></pre>
		<p>If you have installed pps-client as a system service you should start it with </p>
		<pre><code>$ sudo service pps-client start
</code></pre>
		<p>and you should stop it with</p>
		<pre><code>$ sudo service pps-client stop
</code></pre>
		<p>The "
			<code>pps-client -v</code>" command continues to work as described above.
		</p>
		<h1 id="performance-summary">Performance Summary</h1>
		<hr/>
		<p>Figure 1 is a distribution of the corrections (dark blue) made by pps-client to the system time of an RPi 2 over a 24 hour period and continuously accumulated in the file 
			<code>/var/local/error-distrib</code> when 
			<code>error-distrib=enable</code> was set in the pps-client configuration file, 
			<code>/etc/pps-client.conf</code>. These time corrections are superimposed on jitter values (light blue) accumulated over the same period and stored in the file, 
			<code>/var/local/jitter-distrib</code>, with 
			<code>jitter-distrib=enable</code> set in the config. 
		</p>
		<p>Jitter is the variation in the PPS delay reported to the controller by its kernel driver every second. After being cleaned up by the pps-client controller, second-by-second corrections to the time never exceeded one microsecond in any second over this particular 24 hour period. This establishes that the system time was being maintained with a precision of 1 microsecond over this 24 hour period. Also, taking into account other system offsets and uncertainties, absolute time accuracy was within 5 microseconds.</p><center><img src="./figures/offset-distrib.png" alt="Jitter and Corrections Distrib" style="width: 608px;"/></center>

		<p>Figure 2 shows the frequency offset of the system clock over the same 24 hour period. Frequency offset is the value, in parts per million of the uncorrected clock frequency, to which the system clock is adjusted in order to keep it continuously synchronized to the PPS signal. In the pps-client controller, it is the frequency offset that keeps the clock continuously synchronized to within 1 microsecond of the PPS rising edge. Also plotted is the Allan deviation of 1 minute samples in each 5 minute interval. This figure is a graph of data continuously accumulated in a 24 hour circular buffer and written to 
			<code>/var/local/frequency-vars</code> at five minute intervals when 
			<code>frequency-vars=enable</code> was set in the pps-client configuration file.
		</p>
		<p>The frequency offset was compensating for ambient temperature and temperature changes caused by processor activity. Because the frequency offset is set by the pps-client controller, the frequency offset has noise that is introduced by jitter. But as the figure shows, the frequency noise indicated by the Allan deviation will only rarely exceed 20 parts per billion of the system clock oscillator frequency. That would result in a time drift rarely exceeding about 1.2 microseconds per minute. Consequently, not only was the system time error within 1 microsecond at the PPS edge but it was also within 1 microsecond at all times between PPS edges.</p><center><img src="./figures/frequency-vars.png" alt="Frequency Vars over 24 hours" style="width: 685px;"/></center>

	</body>
</html>